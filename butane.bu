variant: fcos
version: 1.4.0
passwd:
  users:
    - name: rancher
      home_dir: /home/rancher
      groups: # adds 'rancher' user to root group
        - docker
        - sudo
        - wheel
      shell: /bin/bash
      ssh_authorized_keys:
        - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIPyOrTl3ywl/WNQW2ag1G4JZBxewcMwZHYmCvkXF9tYY jm@jm2
        - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCuLxsBsAx2QQP4XiPpdsbnbEIxuu2sS1aAXzw3eNYmC8eY+pR2ek5DDu+XwmYw8Jd26ayAeFhEj+QVXaG6nx/XLKmKUWFvjljPwkqT7MJq+3HdjdsPJ/GWabxxVu9rqB/cRiropX7HB7csDoKYQzdizxIN1qy4YyFJueLl/VXhx1ribsIo40LivAMSh+cuGrSzOTBPEsxk1RFsjTQNGkjhByPfNeIUkLRn8bKEeHy8rREfo9EypJdemyyL8phKXFijDruogXuJV2Qr0KJbstJuH3UZAagzOTSG6oY5cQ/RRx4pLL1YPfQ/8YkFNcuiL05YpLDvrYOPOL2SAcTQMjDOZayaLot+qQCqisuokgO9sqOwUIcx4XhubQvc2+puYmzIi+CZYIT5/62tOBpT+qBm/2bD0mEQKfpgodCy/vDSlVp0eqKA9K1UQ5VxbHrEJISTdcWy5Kg655KH90jm//HA54OQIIWkLHwbw7va0YmfF+9xgOYphTu5KlWPJVSv/Fc= jm@jm
systemd:
  units:
    - name: podman.service
      enabled: false
    - name: docker.service
      enabled: true
    - name: rpm-ostree-countme.timer # telemetry
      enabled: false
      mask: true
storage:
  directories:
    - path: /etc/yum.repos.d # remove that directory
      overwrite: true
  files:
    - path: /etc/yum.repos.d/onprem-fedora.repo
      mode: 0644
      contents: # these are enough to install perl|perl-core
        inline: |
          [fedora]
          name=Fedora $releasever - $basearch
          #baseurl=http://download.example/pub/fedora/linux/releases/$releasever/Everything/$basearch/os/
          metalink=https://mirrors.fedoraproject.org/metalink?repo=fedora-$releasever&arch=$basearch
          enabled=1
          countme=1
          metadata_expire=7d
          repo_gpgcheck=0
          type=rpm
          gpgcheck=1
          gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-fedora-$releasever-$basearch
          skip_if_unavailable=False
          [updates]
          name=Fedora $releasever - $basearch - Updates
          #baseurl=http://download.example/pub/fedora/linux/updates/$releasever/Everything/$basearch/
          metalink=https://mirrors.fedoraproject.org/metalink?repo=updates-released-f$releasever&arch=$basearch
          enabled=1
          countme=1
          repo_gpgcheck=0
          type=rpm
          gpgcheck=1
          metadata_expire=6h
          gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-fedora-$releasever-$basearch
          skip_if_unavailable=False
          [fedora-modular]
          name=Fedora Modular $releasever - $basearch
          #baseurl=http://download.example/pub/fedora/linux/releases/$releasever/Modular/$basearch/os/
          metalink=https://mirrors.fedoraproject.org/metalink?repo=fedora-modular-$releasever&arch=$basearch
          enabled=1
          countme=1
          metadata_expire=7d
          repo_gpgcheck=0
          type=rpm
          gpgcheck=1
          gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-fedora-$releasever-$basearch
          skip_if_unavailable=False
          [updates-modular]
          name=Fedora Modular $releasever - $basearch - Updates
          #baseurl=http://download.example/pub/fedora/linux/updates/$releasever/Modular/$basearch/
          metalink=https://mirrors.fedoraproject.org/metalink?repo=updates-released-modular-f$releasever&arch=$basearch
          enabled=1
          countme=1
          repo_gpgcheck=0
          type=rpm
          gpgcheck=1
          metadata_expire=6h
          gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-fedora-$releasever-$basearch
          skip_if_unavailable=False
          [updates-archive]
          name=Fedora $releasever - $basearch - Updates Archive
          baseurl=https://fedoraproject-updates-archive.fedoraproject.org/fedora/$releasever/$basearch/
          enabled=1
          metadata_expire=6h
          repo_gpgcheck=0
          type=rpm
          gpgcheck=1
          gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-fedora-$releasever-$basearch
          skip_if_unavailable=True
          cost=10000 # default is 1000
    - path: /etc/hostname
      mode: 0644
      contents:
        inline: |
          fcos-node01
    - path: /etc/sysctl.d/20-silence-audit.conf
      mode: 0644
      contents:
        inline: |
          # Raise console message logging level from DEBUG (7) to WARNING (4)
          # to hide audit messages from the interactive console
          kernel.printk=4
    - path: /etc/systemd/zram-generator.conf
      mode: 0644
      contents:
        inline: |
          # This config file enables a /dev/zram0 device with the default settings
          [zram0]
    - path: /home/rancher/setup.sh
      mode: 0775
      contents:
        inline: |
          #!/bin/bash
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          sudo mv kubectl /usr/local/bin/kubectl
          sudo chmod +x /usr/local/bin/kubectl
          sudo rpm-ostree install firewalld perl perl-core \
            open-vm-tools tree nano git tig lsscsi \
            sg3_utils device-mapper-multipath nfs-utils

          curl -LOJ https://github.com/rancher/rke2-selinux/releases/download/v0.8.testing.2/rke2-selinux-0.8-2.el8.noarch.rpm
          sudo rpm-ostree install rke2-selinux-0.8-2.el8.noarch.rpm

          curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3
          sudo chmod 700 get_helm.sh
          sudo ./get_helm.sh

          sudo systemctl stop zincati.service
          sudo reboot
    - path: /home/rancher/se2.sh
      mode: 0775
      contents:
        inline: |
          #!/bin/bash
          echo 'source <(kubectl completion bash)' >>~/.bashrc
          kubectl completion bash > /home/rancher/kubectl
          sudo mv /home/rancher/kubectl /etc/bash_completion.d/kubectl
          echo 'alias k=kubectl' >>~/.bashrc
          echo 'complete -F __start_kubectl k' >>~/.bashrc

          # for trident CSI
          sudo sed -i 's/^\(node.session.auth.chap_algs\).*/\1 = MD5/' /etc/iscsi/iscsid.conf
          sudo sed -i 's/^\(node.session.scan\).*/\1 = manual/' /etc/iscsi/iscsid.conf
          sudo mpathconf --enable --with_multipathd y --find_multipaths n

          sudo systemctl enable firewalld.service
          sudo systemctl enable --now iscsid multipathd
          sudo systemctl restart iscsi.service multipathd.service
          sudo systemctl enable --now iscsi

          sudo firewall-cmd --permanent --add-port=22/tcp
          sudo firewall-cmd --permanent --add-port=80/tcp
          sudo firewall-cmd --permanent --add-port=443/tcp
          sudo firewall-cmd --permanent --add-port=2376/tcp
          sudo firewall-cmd --permanent --add-port=2379/tcp
          sudo firewall-cmd --permanent --add-port=2380/tcp
          sudo firewall-cmd --permanent --add-port=6443/tcp
          sudo firewall-cmd --permanent --add-port=8472/udp
          sudo firewall-cmd --permanent --add-port=9099/tcp
          sudo firewall-cmd --permanent --add-port=9345/tcp
          sudo firewall-cmd --permanent --add-port=10250/tcp
          sudo firewall-cmd --permanent --add-port=10254/tcp
          sudo firewall-cmd --permanent --add-port=30000-32767/tcp
          sudo firewall-cmd --permanent --add-port=30000-32767/udp

          sudo firewall-cmd --permanent --direct --add-rule ipv4 filter FORWARD 99 -o cali+ -j ACCEPT
          sudo firewall-cmd --permanent --direct --add-rule ipv4 filter FORWARD 99 -i cali+ -j ACCEPT
          sudo firewall-cmd --direct --add-rule ipv4 filter FORWARD 99 -o cali+ -j ACCEPT
          sudo firewall-cmd --direct --add-rule ipv4 filter FORWARD 99 -i cali+ -j ACCEPT
          sudo firewall-cmd --reload
          
          sudo systemctl restart firewalld.service
          sudo systemctl restart docker.service
          sudo systemctl restart NetworkManager          
          sudo reboot
    - path: /home/rancher/rke2.sh # https://docs.rke2.io/install/quickstart.html
      mode: 0775
      contents:
        inline: |
          #!/bin/bash
          curl -sfL https://get.rke2.io | sudo sh -
          sudo systemctl enable rke2-server.service
          sudo systemctl start rke2-server.service
          sleep 440

          helm repo add rancher-latest https://releases.rancher.com/server-charts/latest
          helm fetch rancher-latest/rancher
          helm repo add jetstack https://charts.jetstack.io
          helm repo update
          helm fetch jetstack/cert-manager --version v1.2.0
          kubectl --kubeconfig /etc/rancher/rke2/rke2.yaml create namespace cert-manager
          helm template cert-manager ./cert-manager-v1.2.0.tgz --output-dir . \
              --namespace cert-manager \
              --set image.repository=quay.io/jetstack/cert-manager-controller \
              --set webhook.image.repository=quay.io/jetstack/cert-manager-webhook \
              --set cainjector.image.repository=quay.io/jetstack/cert-manager-cainjector
          curl -L -o cert-manager/cert-manager-crd.yaml https://github.com/jetstack/cert-manager/releases/download/v1.2.0/cert-manager.crds.yaml
          kubectl --kubeconfig /etc/rancher/rke2/rke2.yaml apply -f cert-manager/cert-manager-crd.yaml
          kubectl --kubeconfig /etc/rancher/rke2/rke2.yaml apply -R -f cert-manager/templates/


          kubectl --kubeconfig /etc/rancher/rke2/rke2.yaml create namespace cattle-system
          helm template rancher ./rancher-2.5.9.tgz --output-dir . \
              --no-hooks \
              --namespace cattle-system \
              --set hostname=rancher.localhost \
              --set certmanager.version=1.2.0 \
              --set rancherImage=rancher/rancher \
              --set useBundledSystemChart=true
          kubectl --kubeconfig /etc/rancher/rke2/rke2.yaml -n cattle-system apply -R -f ./rancher

    - path: /etc/rancher/rke2/config.yaml
      mode: 0777
      contents:
        inline: |
          selinux: false # selinux is currently not working
          write-kubeconfig-mode: "0644"
          disable-cloud-controller: true
    - path: /etc/NetworkManager/conf.d/rke2-canal.conf
      mode: 0600
      contents:
        inline: |
          [keyfile]
          unmanaged-devices=interface-name:cali*;interface-name:flannel*
